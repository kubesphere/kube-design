name: Update Algolia DocSearch Index

on:
  # 1. Automatically triggered on push to main branch (most common)
  push:
    branches:
      - main
      - master # Add master branch if you use it

  # 2. Manual trigger (important!)
  workflow_dispatch:
    # Optional: Add an input field for manually entering the site URL (remove these lines if not needed)
    inputs:
      site_url:
        description: 'Site URL (defaults to start_urls from config)'
        required: false
        default: ''

jobs:
  algolia:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read docsearch.json configuration
        id: algolia_config
        run: |
          CONFIG=$(cat docusaurus/algolia-crawler-config.json | jq -c .)
          echo "config=$CONFIG" >> $GITHUB_OUTPUT

      - name: Override start_urls in config if URL is manually entered (optional feature)
        if: github.event.inputs.site_url != ''
        run: |
          NEW_CONFIG=$(jq --arg url "${{ github.event.inputs.site_url }}" \
            '.start_urls[0].url = $url' docsearch.json)
          echo "$NEW_CONFIG" > docsearch.json.tmp
          mv docsearch.json.tmp docsearch.json
          echo "Replaced with manually entered URL: ${{ github.event.inputs.site_url }}"

      - name: Run Algolia official crawler
        env:
          APPLICATION_ID: ${{ secrets.APPLICATION_ID }} # Your Application ID
          API_KEY: ${{ secrets.API_KEY }} # Your Admin API Key (write permission)
          CONFIG: ${{ steps.algolia_config.outputs.config }}
        run: |
          docker run --rm \
            --env APPLICATION_ID=${APPLICATION_ID} \
            --env API_KEY=${API_KEY} \
            --env "CONFIG=${CONFIG}" \
            algolia/docsearch-scraper
